name: CI

on:
  push:
    branches:
      - "main"
      - "*.*"
      - "!*backport*"
    tags:
      - "v*"
      - "!*dev*"
      - "!*pre*"
      - "!*post*"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/publish.yml@main
    with:
      test_extras: "dev"
      test_command: 'pytest -p no:warnings --doctest-rst -m "not mpl_image_compare" --pyargs pyflct'
      submodules: false
      libraries: libfftw3-dev
      targets: |
        - cp39-manylinux*_x86_64
        - cp39-macosx_x86_64
        # - cp310-manylinux*_x86_64
        # - cp310-macosx_x86_64
        # - cp311-manylinux*_x86_64
        # - cp311-macosx_x86_64
    secrets:
      pypi_token: ${{ secrets.pypi_token }}
